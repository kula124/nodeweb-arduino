<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>title</title>
  <meta name="author" content="name">
  <meta name="description" content="description here">
  <meta name="keywords" content="keywords,here">
  <link rel="stylesheet" href="gyro.css" type="text/css">
  <script src="http://localhost:3000/socket.io/socket.io.js"></script>
  <script>
    let leftOn=false;
    let rightOn=false;
    let connected=false;
    let state={
      alpha: 0,
      beta: 0,
      gamma: 0
    }
    let socket=io('http://localhost:3000');
    socket.on('connect',() => {
      connected=true;
    })
    socket.on('disconnect',() => {
      connected=false;
      state={
        alpha: 0,
        beta: 0,
        gamma: 0
      }
    })
    socket.close()

    function calculateDelta(state,event) {
      return {
        dAlpha: state.alpha-event.alpha,
        dBeta: state.beta-event.beta,
        dGamma: state.gamma-event.gamma,
      }
    }

    function toggleConnect() {
      if(connected) {
        socket.close()
      }
      else {
        socket.open('http://localhost:3000')
      }

    }

    function handleOrientation(e) {
      console.log('hi',leftOn,rightOn,connected,e)

      if(leftOn&&rightOn&&connected) {
        state={
          ...e
        }

        while(leftOn&&rightOn&&connected) {
          socket.send(JSON.stringify({ ...calculateDelta(state,e),type: 'GYRO.DATA' }))
        }
        if(connected) {
          socket.send(JSON.stringify({ type: 'GYRO.STOP' }))
        }
      }
    }

    function toggleLeft() {
      console.log('hi',leftOn,rightOn);
      leftOn=!leftOn;
    }

    function toggleRight() {
      console.log('hi',leftOn,rightOn);
      rightOn=!rightOn;
    }
  </script>
</head>

<body>
  <header>Controller</header>
  <button onclick="toggleConnect()">Connect</button>
  <section class="controllersContainer">
    <div class="controller" ontouchstart="toggleLeft()">
    </div>
    <div class="controller" ontouchstart="toggleRight()">
    </div>
  </section>
  <div class="cover">

  </div>


  <script type="text/javascript">
    function autorun() {
      window.addEventListener("deviceorientation",handleOrientation,true);
    }
    if(document.addEventListener) document.addEventListener("DOMContentLoaded",autorun,false);
    else if(document.attachEvent) document.attachEvent("onreadystatechange",autorun);
    else window.onload=autorun;
  </script>
</body>

</html>